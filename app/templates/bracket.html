{% extends "base.html" %}
{% block content %}
<h2 class="mb-4">Tournament Bracket</h2>

<style>
	.bracket-grid {
		display: grid;
		grid-auto-flow: column;
		grid-auto-columns: 220px;
		grid-auto-rows: 10px; /* Fine granularity */
		column-gap: 30px;
		row-gap: 0;
		position: relative;
	}

	.match-box {
		width: 200px;
		min-height: 120px;
		background: white;
		border: 1px solid #ccc;
		border-radius: 6px;
		padding: 10px;
		text-align: center;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		gap: 5px;
	}

	.match-box .vs {
		color: #888;
		font-size: 0.9rem;
		margin: 4px 0;
	}
</style>

<div class="bracket-grid">
	{% for match in bracket.all_matches %}
	<div class="match-box"
		style="grid-column: {{ match.x + 1 }};
			grid-row-start: {{ (match.y * 4)|int + 1 }};
			grid-row-end: span 12;">

	<!-- Form wraps player rows and submit together -->
	{% if match.player1 and match.player2 and match.score1 is none and match.score2 is none %}
	<form method="POST" action="{{ url_for('main.submit_score') }}" class="w-100">
		<input type="hidden" name="round_index" value="{{ match.round_index }}">
		<input type="hidden" name="match_index" value="{{ match.match_index }}">

		<!-- Player 1 -->
		<div class="d-flex align-items-center justify-content-between w-100 mb-1">
			<div class="text-start">
				<img src="{{ url_for('static', filename='avatars/' ~ match.player1.avatar_filename) }}" width="40" class="rounded-circle me-2">
				<strong>{{ match.player1.name }}</strong>
			</div>
			<input type="number" name="score1" placeholder="Score" required style="width: 60px;" class="form-control form-control-sm">
		</div>

		<!-- Player 2 -->
		<div class="d-flex align-items-center justify-content-between w-100 mb-2">
			<div class="text-start">
				<img src="{{ url_for('static', filename='avatars/' ~ match.player2.avatar_filename) }}" width="40" class="rounded-circle me-2">
				<strong>{{ match.player2.name }}</strong>
			</div>
			<input type="number" name="score2" placeholder="Score" required style="width: 60px;" class="form-control form-control-sm">
		</div>

		<!-- Submit Button -->
		<div class="text-center">
			<button type="submit" class="btn btn-sm btn-success">Submit</button>
		</div>
	</form>

	{% else %}
		<!-- Player 1 -->
		<div class="d-flex align-items-center justify-content-between w-100 mb-1">
			{% if match.player1 %}
				<div class="text-start">
					<img src="{{ url_for('static', filename='avatars/' ~ match.player1.avatar_filename) }}" width="40" class="rounded-circle me-2">
					<strong>{{ match.player1.name }}</strong>
				</div>
				{% if match.score1 is not none %}
					<div>Score: {{ match.score1 }}</div>
				{% endif %}
			{% else %}
				<div class="text-start">
					<img src="{{ url_for('static', filename='avatars/default.png') }}" width="40" class="rounded-circle opacity-50 me-2">
					<em>TBD</em>
				</div>
			{% endif %}
		</div>

		<!-- Player 2 -->
		<div class="d-flex align-items-center justify-content-between w-100">
			{% if match.player2 %}
				<div class="text-start">
					<img src="{{ url_for('static', filename='avatars/' ~ match.player2.avatar_filename) }}" width="40" class="rounded-circle me-2">
					<strong>{{ match.player2.name }}</strong>
				</div>
				{% if match.score2 is not none %}
					<div>Score: {{ match.score2 }}</div>
				{% endif %}
			{% else %}
				<div class="text-start">
					<img src="{{ url_for('static', filename='avatars/default.png') }}" width="40" class="rounded-circle opacity-50 me-2">
					<em>TBD</em>
				</div>
			{% endif %}
		</div>
	{% endif %}
	</div>
	{% endfor %}
</div>
{% endblock %}
